<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Login</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #f5f5f5;
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
      margin: 0;
    }
    .card {
      background: white;
      padding: 1.5rem;
      border-radius: 0.75rem;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.08);
      width: 100%;
      max-width: 420px;
    }
    h1 {
      margin-top: 0;
      font-size: 1.3rem;
      text-align: center;
    }
    label {
      display: block;
      margin-top: 0.75rem;
      font-size: 0.9rem;
    }
    input {
      width: 100%;
      padding: 0.5rem 0.6rem;
      margin-top: 0.25rem;
      border-radius: 0.4rem;
      border: 1px solid #ccc;
      font-size: 0.95rem;
    }
    button {
      margin-top: 1rem;
      width: 100%;
      padding: 0.6rem;
      border-radius: 0.4rem;
      border: none;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      background: #2563eb;
      color: white;
    }
    button:disabled {
      opacity: 0.6;
      cursor: default;
    }
    .message {
      margin-top: 0.75rem;
      font-size: 0.9rem;
      min-height: 1.2em;
    }
    .message.error {
      color: #b91c1c;
    }
    .message.success {
      color: #15803d;
    }
  </style>
</head>
<body>
  <div class="card">
    <h1>Login</h1>
    <form id="login-form">
      <label>
        Email
        <input
          type="email"
          required
          data-testid="login-email"
          id="login-email"
          autocomplete="email"
        />
      </label>

      <label>
        Password
        <input
          type="password"
          required
          minlength="8"
          data-testid="login-password"
          id="login-password"
          autocomplete="current-password"
        />
      </label>

      <button type="submit" data-testid="login-submit">
        Login
      </button>

      <!-- IMPORTANT: tests use #message -->
      <div
        class="message"
        id="message"
        data-testid="login-message"
      ></div>
    </form>
  </div>

  <script>
    const loginForm = document.getElementById("login-form");
    const loginEmail = document.getElementById("login-email");
    const loginPassword = document.getElementById("login-password");
    const loginMessage = document.getElementById("message");
    const loginButton = document.querySelector('[data-testid="login-submit"]');

    function setLoginMessage(text, type) {
      loginMessage.textContent = text;
      loginMessage.classList.remove("error", "success");
      if (type) loginMessage.classList.add(type);
    }

    loginForm.addEventListener("submit", async (event) => {
      event.preventDefault();
      setLoginMessage("", null);

      const email = loginEmail.value.trim();
      const password = loginPassword.value;

      if (!email || !password) {
        setLoginMessage("Email and password are required.", "error");
        return;
      }

      loginButton.disabled = true;

      try {
        const resp = await fetch("/users/login", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ email, password }),
        });

        let data = {};
        try {
          data = await resp.json();
        } catch (_) {}

        if (resp.status === 200) {
          // Match tests + integration expectations
          setLoginMessage("Login successful", "success");
          if (data.access_token) {
            localStorage.setItem("token", data.access_token);
          }
        } else if (resp.status === 401) {
          // EXACT text for wrong password test
          setLoginMessage("Invalid credentials", "error");
        } else {
          setLoginMessage(data.detail || "Login failed.", "error");
        }
      } catch (err) {
        setLoginMessage("Network error while logging in.", "error");
      } finally {
        loginButton.disabled = false;
      }
    });
  </script>
</body>
</html>
